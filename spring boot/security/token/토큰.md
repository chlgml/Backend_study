## Token 인증 방식

http의 특성상 로그인의 정보등이 저장되지 않는다. 이러한 단점을 보안하기 위하여 세션, 토큰 등은 웹 통신 정보를 저장해준다. (세션은 여기서 다루지 않도록 하겠다.)

토큰은 세션보다 비교적 보안이 좋다. 하지만 중간에 토큰을 탈취한다면 보안에 큰 취약점이 생긴다. 그러므로 토큰은 유효기간을 설정한다.

- 무상태성&확장성

  토큰은 클라이언트 측에 저장되기 때문에 클라이언트와 서버간의 연결고리가 없으므로 확장에 유리하다. 또한 사용자 정보가 서버측에 저장된다면 서버를 확장하여 분산처리 할 경우, 해당 사용자가 처음 로그인 했었던
  서버에만 요청을 받도록 설정해주어야 하지만, 토큰을 사용하면 어떠한 서버로 요청이 들어와도 문제가 발생하지 않는다.

- 여러 플랫폼 및 도메인

  서버 기반 인증 시스템의 문제점 중 CORS를 해결 할 수 있다. 토큰을 사용하면 어떤 디바이스, 어떤 도메인에서도 토큰의 유효성 검사를 진행한 후에 요청을 처리 할 수 있게 된다.
  
  

### JWT

***********

JSON Web Token의 약자로, Header.Payload.Signature으로 구성되어 있다.

- Header(해더)

  typ과 alg 두가지 정보로 구성, alg는 해더를 암호화하는 것이 아닌 signature를 해싱하기 위한 알고리즘을 지정하는 것이다.

    - typ : 토큰의 타입을 지정

      ex)  JWT

    - alg : 알고리즘 방식을 지정, 서명및 토큰 검증에 사용

      ex)  HS256(SHA256) 또는 RSA


- Payload(페이로드)

  토큰에서 사용할 정보의 조각인 클레임이 담겨 있음

    - claim

        - 등록된 클레임 : 토큰의 정보를 표현하기 위해 이미 만들어진 종류의 데이터

          iss : 토큰 발급자 sub : 토큰 제목 aud : 토큰 대상자 jti : 토큰 식별자(중복 방지, accass토큰등에 사용)

          exp : 토큰 만료 시간 nbf : 토큰 활성날짜 iat : 토큰 발급 시간

        - 공개 클레임 : 사용자 정의 클레임으로 공개용 정보를 위해 사용, 충돌방지를 위해 URI포맷 사용

        - 비공개 클레임 : 사용자 정의 클레임으로 서버와 클라이언트 사이에 임의로 지정한 정보 저장


- Signature(서명)

  토큰을 인코딩하거나 유효성을 검증할때 사용한다. 해더와 페이로드를 각각 BASE64로 인코딩하고 인코딩한 값을 비밀키를 이용해 해더에서 정의한 알고리즘으로 해싱하고 이를 다시 BASE64로 인코딩하여 생성한다.
  
  

**토큰 생성**

```java
Jwts.builder()
  .setHeaderParam(Header.TYPE, Header.JWT_TYPE) // 해더의 타입을 지정
  .setExpiration(new Date(System.currentTimeMillis() + AccessToken * 1000)) // exp
  .setIssuedAt(new Date()) // iat
  .setSubject(authentication.getName()) // sub
  .signWith(SignatureAlgorithm.HS256, SecretKey) // 해싱 알고리즘과 시크릿키를 설정할 수 있다.
  .compact();
```



**토큰의 단점**

- JWT는 상태를 저장하지 않기 떄문에 한번 만들어지면 제어가 불가능하다. 즉, 임의로 토큰을 삭제 하지 못하므로 해커에게 토큰을 빼앗기면 토큰을 무효화 할 방법이 없다. 그러므로 토큰의 만료시간을 넣어줘야 한다.
    - 토큰은 Access Token과 Refresh Token이 있다. Access Token은 유효시간이 설정되어 있는 토큰으로 설정되어 있던 시간이 다 되면 자동으로 소멸된다.
    - refresh token도 탈취 당하면 똑같이 보안상 취약점이 생기지만, refresh token을 쓰는 빈도수가 낮기 때문에 탈취될 위험이 적다.
- 페이로드 자체는 암호화 된 것이 아니라 인코딩이 된 것이므로 중간에 탈취당하면 데이터를 볼 수 있으므로 중요한 데이터는 넣지 않는다.



**인증, 인가**

Authentication(인증) ---인증후---> Authoriztion(인가)

- 인증 : 해당 사용자가 본인이 맞는지 확인하는 절차
- 인가 : 인증된 사용자가 요청된 자원에 접근가능한지 결정하는 절차



**토큰 인증 방식 설계**

1. 로그인시 Access Token과 Refresh Token 발급
    - 이때 Access Token과 Refresh Token의 시간은 웹에 따라 다를 수 있지만, Access Token 30분, Refresh Token 1주일로 설정하고 있다.
2. 클라이언트는 서버에 요청을 할때, Access Token을 포함하여 요청을 보냄
3. Access Token토큰이 정상적이라면 요청에대한 응답을 준다. Access Token토큰이 만료되었다면 클라이언트는 토큰 재발급 요청을 한다.
4. 클라이언트는 Access Token과 Refresh Token을 통하여 재발급요청을 한다. 서버는 토큰을 검사한 후 토큰 재발급을 해준다.